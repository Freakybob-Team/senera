<!DOCTYPE html>
<html>

<head>
    <meta content="Senera Public Beta" property="og:title" />
    <meta content="A new era is here." property="og:description" />
    <meta content="https://senera.freakybob.site" property="og:url" />
    <meta content="https://senera.freakybob.site/logos/senera-banner.png" property="og:image" />
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <title>Senera Public Beta</title>
    <link rel="icon" href="logos/32x32.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/css.css">
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            onChildAdded,
            get,
            remove,
            onChildChanged,
            onChildRemoved,
            onValue,
            onDisconnect
        } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            GithubAuthProvider,
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult,
            signInWithCredential
        } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
  const firebaseConfig = {

    apiKey: "AIzaSyCh3u1OK7oHW1RZ7jIhgC1WPX9Az4vWcBE",

    authDomain: "senera-app.firebaseapp.com",

    projectId: "senera-app",

    storageBucket: "senera-app.firebasestorage.app",

    messagingSenderId: "279962559878",

    appId: "1:279962559878:web:895faf6acf3b9a5ca23807"

  };


        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const messagesRef = ref(database, 'messages');
        const typingRef = ref(database, 'typing');
        const pingAudio = new Audio('sound.wav');
        const provider = new GithubAuthProvider();
        let typingTimeout;
        let currentReply = null;

        function setReply(messageId, author, messageText) {
            currentReply = { messageId, author, messageText };
            displayReplyIndicator();
        }
        window.setReply = setReply;

        function cancelReply() {
            currentReply = null;
            const replyIndicator = document.getElementById('replyIndicator');
            if (replyIndicator) replyIndicator.style.display = 'none';
        }

        function displayReplyIndicator() {
            const replyIndicator = document.getElementById('replyIndicator');
            if (replyIndicator && currentReply) {
                replyIndicator.classList.remove('collapsed');
                replyIndicator.innerHTML = `<img src="reply.svg" alt="Reply" style="width:24px;height:24px;vertical-align:middle;"><span class="reply-text">"${escapeHTML(currentReply.messageText.slice(0, 30))}..."</span> <span class="cancel" title="Cancel reply">[x]</span>`;
                replyIndicator.style.display = 'flex';
                replyIndicator.querySelector('.cancel').addEventListener('click', cancelReply);
                setTimeout(() => {
                    replyIndicator.classList.add('collapsed');
                }, 5000);
            }
        }

        document.getElementById('replyIndicator').addEventListener('mouseenter', () => {
            const replyIndicator = document.getElementById('replyIndicator');
            replyIndicator.classList.remove('collapsed');
        });

        document.getElementById('replyIndicator').addEventListener('mouseleave', () => {
            const replyIndicator = document.getElementById('replyIndicator');
            setTimeout(() => {
                replyIndicator.classList.add('collapsed');
            }, 5000);
        });


        const emojiMap = {
            // Faces
            ":sob:": "ğŸ˜­",
            ":smile:": "ğŸ˜ƒ",
            ":heart:": "â¤ï¸",
            ":broken_heart:": "ğŸ’”",
            ":thumbsup:": "ğŸ‘",
            ":fire:": "ğŸ”¥",
            ":laughing:": "ğŸ˜†",
            ":confused:": "ğŸ˜•",
            ":cry:": "ğŸ˜¢",
            ":sweat:": "ğŸ˜…",
            ":sweat_smile:": "ğŸ˜…",
            ":joy:": "ğŸ˜‚",
            ":sunglasses:": "ğŸ˜",
            ":star_struck:": "ğŸ¤©",
            ":thinking:": "ğŸ¤”",
            ":sleeping:": "ğŸ˜´",
            ":pensive:": "ğŸ˜”",
            ":grin:": "ğŸ˜",
            ":wink:": "ğŸ˜‰",
            ":kiss:": "ğŸ˜˜",
            ":yum:": "ğŸ˜‹",
            ":clap:": "ğŸ‘",
            ":wave:": "ğŸ‘‹",
            ":muscle:": "ğŸ’ª",
            ":raised_hands:": "ğŸ™Œ",
            ":pray:": "ğŸ™",
            ":sparkles:": "âœ¨",
            ":biceps:": "ğŸ’ª",
            ":robot:": "ğŸ¤–",
            ":alien:": "ğŸ‘½",
            ":unicorn:": "ğŸ¦„",
            ":santa:": "ğŸ…",
            ":party:": "ğŸ¥³",
            ":exploding_head:": "ğŸ¤¯",
            ":shushing:": "ğŸ¤«",
            ":nerd:": "ğŸ¤“",
            ":woozy:": "ğŸ¥´",
            ":facepalm:": "ğŸ¤¦",
            ":mind_blown:": "ğŸ¤¯",
            ":innocent:": "ğŸ˜‡",
            ":speaking_head:": "ğŸ—£ï¸",

            // Food & Drinks
            ":birthday:": "ğŸ‚",
            ":champagne:": "ğŸ¾",
            ":pizza:": "ğŸ•",
            ":hamburger:": "ğŸ”",
            ":popcorn:": "ğŸ¿",
            ":taco:": "ğŸŒ®",
            ":coffee:": "â˜•",
            ":beer:": "ğŸº",
            ":wine_glass:": "ğŸ·",
            ":cake:": "ğŸ°",
            ":cocktail:": "ğŸ¸",
            ":donut:": "ğŸ©",
            ":cookie:": "ğŸª",
            ":chocolate:": "ğŸ«",
            ":fries:": "ğŸŸ",
            ":icecream:": "ğŸ¦",
            ":sushi:": "ğŸ£",
            ":hotdog:": "ğŸŒ­",
            ":avocado:": "ğŸ¥‘",

            // Animals & Nature
            ":rose:": "ğŸŒ¹",
            ":sunflower:": "ğŸŒ»",
            ":bouquet:": "ğŸ’",
            ":leaf:": "ğŸƒ",
            ":dog:": "ğŸ¶",
            ":cat:": "ğŸ±",
            ":panda:": "ğŸ¼",
            ":monkey:": "ğŸµ",
            ":turtle:": "ğŸ¢",
            ":whale:": "ğŸ³",
            ":shark:": "ğŸ¦ˆ",
            ":soccer:": "âš½",
            ":basketball:": "ğŸ€",
            ":football:": "ğŸˆ",
            ":tennis:": "ğŸ¾",
            ":guitar:": "ğŸ¸",
            ":microphone:": "ğŸ¤",
            ":video_game:": "ğŸ®",
            ":headphones:": "ğŸ§",
            ":camera:": "ğŸ“·",
            ":computer:": "ğŸ’»",
            ":phone:": "ğŸ“±",
            ":lightbulb:": "ğŸ’¡",

            // Symbols & Misc
            ":check:": "âœ”ï¸",
            ":x:": "âŒ",
            ":warning:": "âš ï¸",
            ":question:": "â“",
            ":exclamation:": "â—",
            ":100:": "ğŸ’¯",
            ":money:": "ğŸ’°",
            ":crown:": "ğŸ‘‘",
            ":lock:": "ğŸ”’",
            ":unlock:": "ğŸ”“",
            ":key:": "ğŸ”‘",
            ":rainbow:": "ğŸŒˆ",
            ":star:": "â­",
            ":boom:": "ğŸ’¥",
            ":hourglass:": "â³",
        };


        function escapeHTML(str) {
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function escapeAttribute(str) {
            return str.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/'/g, "&#39;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function processMessage(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const parts = text.split(urlRegex);

            if (parts.length === 3 && parts[0] === "" && parts[2] === "" && parts[1].match(/\.(jpeg|jpg|gif|png|apng|jfif|webp|avif|pjpeg|pjp|svg|mp4|mp3)$/i)) {
                if (parts[1].match(/\.mp4$/i)) {
                    return `<video controls style="max-width: 300px; border-radius: 8px;"><source src="${escapeAttribute(parts[1])}" type="video/mp4">Your browser does not support the video tag.</video>`;
                } else if (parts[1].match(/\.mp3$/i)) {
                    return `<audio controls style="max-width: 300px;"><source src="${escapeAttribute(parts[1])}" type="audio/mpeg">Your browser does not support the audio tag.</audio>`;
                } else if (localStorage.getItem('loadImageEmbeds') === 'true') {
                    return `<img src="${escapeAttribute(parts[1])}" style="max-width: 300px; border-radius: 8px;">`;
                } else {
                    return `<a href="${escapeAttribute(parts[1])}" target="_blank">${escapeHTML(parts[1])}</a>`;
                }
            }

            let result = '';
            for (let part of parts) {
                if (part.match(urlRegex)) {
                    if (part.match(/\.(jpeg|jpg|gif|png|apng|jfif|webp|avif|pjpeg|pjp|svg)$/i)) {
                        if (localStorage.getItem('loadImageEmbeds') === 'true') {
                            result += `<br><img src="${escapeAttribute(part)}" style="max-width: 300px; max-height: 300px; border-radius: 8px;">`;
                        } else {
                            result += `<a href="${escapeAttribute(part)}" target="_blank">${escapeHTML(part)}</a>`;
                        }
                    } else if (part.match(/\.mp4$/i)) {
                        result += `<br><video controls style="max-width: 300px; border-radius: 8px;"><source src="${escapeAttribute(part)}" type="video/mp4">Your browser does not support the video tag.</video>`;
                    } else if (part.match(/\.mp3$/i)) {
                        result += `<br><audio controls style="max-width: 300px;"><source src="${escapeAttribute(part)}" type="audio/mpeg">Your browser does not support the audio tag.</audio>`;
                    }
                    else if (part.includes("youtube.com") || part.includes("youtu.be")) {
                        if (localStorage.getItem('loadYouTubeEmbeds') === 'true') {
                            let videoId = part.match(/[?&]v=([^&#]+)/) ? part.match(/[?&]v=([^&#]+)/)[1] : part.split("youtu.be/")[1];
                            if (videoId) {
                                result += `<br><iframe width="300" height="180" src="https://www.youtube.com/embed/${escapeAttribute(videoId)}" frameborder="0" allowfullscreen></iframe>`;
                            } else {
                                result += `<a href="${escapeAttribute(part)}" target="_blank">${escapeHTML(part)}</a>`;
                            }
                        } else {
                            result += `<a href="${escapeAttribute(part)}" target="_blank">${escapeHTML(part)}</a>`;
                        }
                    } else {
                        result += `<a href="${escapeAttribute(part)}" target="_blank">${escapeHTML(part)}</a>`;
                    }
                } else {
                    result += escapeHTML(part);
                }
            }
            return result;
        }

        function formatTimestamp(ts) {
            const date = new Date(ts);
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? " PM" : " AM";
            hours = hours % 12;
            hours = hours ? hours : 12;
            minutes = minutes < 10 ? "0" + minutes : minutes;
            return `${hours}:${minutes}${ampm}`;
        }

        function submitForm(e) {
            e.preventDefault();
            const messageInput = document.getElementById('message');
            let message = messageInput.value.trim();
            if (message === "") return;
            for (let code in emojiMap) {
                message = message.replaceAll(code, emojiMap[code]);
            }
            const user = auth.currentUser;
            const newMessageRef = push(messagesRef);

            const messageData = {
                name: user.displayName || "Username Error",
                message: message,
                photo: (user && user.photoURL) ? user.photoURL : "default.png",
                timestamp: Date.now()
            };
            if (currentReply) {
                messageData.reply = {
                    author: currentReply.author,
                    messageText: currentReply.messageText
                };
            }

            set(newMessageRef, messageData);
            messageInput.value = "";
            if (currentReply) cancelReply();
            if (user) {
                remove(ref(database, 'typing/' + user.uid));
            }
        }

        const warningMessage = document.getElementById("warning-message");
        if (warningMessage) {
            warningMessage.style.display = "none";
        }


        document.getElementById('message').addEventListener("input", function () {
            let message = document.getElementById('message').value;
            for (let code in emojiMap) {
                message = message.replaceAll(code, emojiMap[code]);
            }
            document.getElementById('message').value = message;
        });


        function loadMessages() {
            const messagesList = document.getElementById("messages");

            onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                const li = document.createElement("li");
                li.id = snapshot.key;
                let formattedMessage = `<img src="${escapeAttribute(msg.photo || 'default.png')}" style="width:30px;height:30px;border-radius:50%; margin-right: 10px;" onerror="this.src='default.png'"> <b>${escapeHTML(msg.name)}</b><br> `;
                if (msg.reply) {
                    formattedMessage += `<div class="reply-info">In reply to <b>@${escapeHTML(msg.reply.author)}</b>: ${escapeHTML(msg.reply.messageText)}</div>`;
                }
                formattedMessage += processMessage(msg.message.trim());
                if (msg.timestamp) {
                    formattedMessage += `<button class="reply-icon" title="Reply" onclick="setReply('${snapshot.key}', '${escapeHTML(msg.name)}', '${escapeHTML(msg.message)}')">â¤»</button>`;
                    if (auth.currentUser && msg.name === auth.currentUser.displayName) {
                        formattedMessage += `<button class="delete-icon" title="Delete" onclick="deleteMessage('${snapshot.key}')"><img src="delete.svg" alt="Delete" style="width:16px;height:16px;"></button>`;
                    }
                    formattedMessage += `<span class="timestamp" style="margin-left: 10px; font-size: 0.8em; color: #aaa;">${formatTimestamp(msg.timestamp)}</span>`;
                }
                li.innerHTML = formattedMessage;
                document.getElementById("messages").appendChild(li);

                twemoji.parse(li, {
                    folder: 'svg',
                    ext: '.svg'
                });

                const currentUser = auth.currentUser;
                if (localStorage.getItem('pingSound') === 'true' && currentUser && currentUser.displayName) {
                    const usernameRegex = new RegExp(`@${currentUser.displayName}\\b`, 'i');
                    if (msg.message.match(usernameRegex) || (msg.reply && msg.reply.author === currentUser.displayName)) {
                        pingAudio.play().catch(err => console.error("Error playing ping sound:", err));

                        const messageElements = document.querySelectorAll('li');
                        messageElements.forEach((messageElement) => {
                            const messageText = messageElement.textContent;

                            if (messageText.includes(`@${currentUser.displayName}`) || messageText.includes(`@${currentUser.displayName.toLowerCase()}`)) {
                                messageElement.classList.add('ping');
                            }
                        });
                    }
                }

                if (localStorage.getItem('unloadMessages') === 'true') {
                    const messages = messagesList.getElementsByTagName("li");
                    while (messages.length > 50) {
                        messagesList.removeChild(messagesList.firstChild);
                    }
                }
                if (isNearBottom()) {
                    scrollToBottom();
                }
            });
        }

        function scrollToBottom() {
            const messagesList = document.getElementById("messages");
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function logout() {
            const user = auth.currentUser;
            if (user) {
                remove(ref(database, 'typing/' + user.uid));
            }
            signOut(auth).then(() => {
                document.getElementById('LOGOUTTHANKSNOMAFORTHECODEongioweyouone').style.display = 'none';
                signInForm.style.display = 'block';
            }).catch(error => {
                console.error("Error logging out:", error.message);
            });
        }

        function isNearBottom() {
            const messagesList = document.getElementById("messages");
            return messagesList.scrollHeight - messagesList.scrollTop - messagesList.clientHeight < 150;
        }
        const typingStatus = {};

        function updateTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            const messagesList = document.getElementById("messages");
            const user = auth.currentUser;
            const typingUsers = [];
            for (const uid in typingStatus) {
                if (!user || uid !== user.uid) {
                    typingUsers.push(typingStatus[uid]);
                }
            }
            if (typingUsers.length > 0) {
                indicator.style.display = "flex";
                messagesList.style.height = "calc(100vh - 134px)";
                if (isNearBottom()) {
                    scrollToBottom();
                }
                let text;
                if (typingUsers.length === 1) {
                    text = typingUsers[0] + " is typing...";
                } else {
                    text = typingUsers.join(', ') + " are typing...";
                }
                indicator.innerHTML = '<img src="typing.svg" alt="Typing">' + text;
            } else {
                indicator.style.display = "none";
                messagesList.style.height = "calc(100vh - 105px)";
            }
        }
        onChildAdded(typingRef, (snapshot) => {
            const uid = snapshot.key;
            const username = snapshot.val();
            typingStatus[uid] = username;
            updateTypingIndicator();
        });
        onChildChanged(typingRef, (snapshot) => {
            const uid = snapshot.key;
            const username = snapshot.val();
            typingStatus[uid] = username;
            updateTypingIndicator();
        });
        onChildRemoved(typingRef, (snapshot) => {
            const uid = snapshot.key;
            delete typingStatus[uid];
            updateTypingIndicator();
        });

        function loadSettings() {
            if (localStorage.getItem('loadYouTubeEmbeds') === null) {
                localStorage.setItem('loadYouTubeEmbeds', 'true');
            }
            if (localStorage.getItem('loadImageEmbeds') === null) {
                localStorage.setItem('loadImageEmbeds', 'true');
            }
            if (localStorage.getItem('unloadMessages') === null) {
                localStorage.setItem('unloadMessages', 'true');
            }
            if (localStorage.getItem('pingSound') === null) {
                localStorage.setItem('pingSound', 'true');
            }
            document.getElementById('loadYouTubeEmbedsC').checked = localStorage.getItem('loadYouTubeEmbeds') === 'true';
            document.getElementById('loadImageEmbedsC').checked = localStorage.getItem('loadImageEmbeds') === 'true';
            document.getElementById('unloadMessagesC').checked = localStorage.getItem('unloadMessages') === 'true';
            document.getElementById('pingSoundC').checked = localStorage.getItem('pingSound') === 'true';
        }

        function attachChatEventListeners() {
            const messageForm = document.getElementById('message-form');
            if (messageForm) {
                messageForm.addEventListener('submit', submitForm);
            }
            const messageInput = document.getElementById('message');

            if (messageInput) {
                messageInput.addEventListener('input', function () {
                    const maxLength = 300;
                    const remaining = maxLength - this.value.length;
                    const charLimit = document.getElementById('charLimit');
                    if (charLimit) {
                        charLimit.textContent = remaining;
                    }
                    const user = auth.currentUser;
                    if (!user) return;
                    if (this.value.trim().length > 0) {
                        set(ref(database, 'typing/' + user.uid), user.displayName || "Unknown");
                        clearTimeout(typingTimeout);
                        typingTimeout = setTimeout(() => {
                            remove(ref(database, 'typing/' + user.uid));
                        }, 3000);
                    } else {
                        remove(ref(database, 'typing/' + user.uid));
                        clearTimeout(typingTimeout);
                    }
                });
                messageInput.addEventListener('keydown', function (e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        const sendButton = document.getElementById('send');
                        if (sendButton) {
                            sendButton.click();
                        }
                        const charLimit = document.getElementById('charLimit');
                        if (charLimit) {
                            charLimit.textContent = "300";
                        }
                    }
                });
            }
            const settingsButton = document.getElementById('settings');
            if (settingsButton) {
                settingsButton.addEventListener('click', () => {
                    if (auth.currentUser) {
                        document.getElementById('settings-pfp').value = auth.currentUser.photoURL || "default.png";
                    }
                    loadSettings();
                    document.getElementById('modal-settings').style.display = "flex";
                });
            }
            const feedbackButton = document.getElementById('feedback');
            if (feedbackButton) {
                feedbackButton.addEventListener('click', () => {
                    document.getElementById('modal-feedback').style.display = "flex";
                });
            }



            const helpButton = document.getElementById('help');
            if (helpButton) {
                helpButton.addEventListener('click', () => {
                    document.getElementById('modal-help').style.display = "flex";
                });
            }
            const logoutButton = document.getElementById('LOGOUTTHANKSNOMAFORTHECODEongioweyouone');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    logout();
                });
            }

            const saveSettingsButton = document.getElementById('saveSettings');
            if (saveSettingsButton) {
                saveSettingsButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    const newPfp = document.getElementById('settings-pfp').value.trim() || "default.png";

                    localStorage.setItem('loadYouTubeEmbeds', document.getElementById('loadYouTubeEmbedsC').checked);
                    localStorage.setItem('loadImageEmbeds', document.getElementById('loadImageEmbedsC').checked);
                    localStorage.setItem('unloadMessages', document.getElementById('unloadMessagesC').checked);
                    localStorage.setItem('pingSound', document.getElementById('pingSoundC').checked);

                    if (auth.currentUser) {
                        updateProfile(auth.currentUser, { photoURL: newPfp })
                            .catch(error => console.error("Error updating profile picture:", error.message));
                    }

                    document.getElementById('modal-settings').style.display = "none";
                });
            }

            const savePFPButton = document.getElementById('savePFP');
            if (savePFPButton) {
                savePFPButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    const newPfp = document.getElementById('settings-pfp').value.trim() || "default.png";
                    if (auth.currentUser) {
                        updateProfile(auth.currentUser, { photoURL: newPfp })
                            .catch(error => console.error("Error updating profile picture:", error.message));
                    }
                    document.getElementById('modal-content').style.display = "none";
                });
            }

            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', function () {
                    this.parentElement.parentElement.style.display = "none";
                });
            });
            window.addEventListener('click', function (e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = "none";
                }
            });
        }
        const userSettingsBTN = document.querySelector('.user-settingsBTN');
        const modal = document.getElementById('user-settings');
        const closeButton = modal.querySelector('.close');
        const saveButton = document.getElementById('saveStatus');
        const statusInput = document.getElementById('status');
        const charLimitDisplay = document.getElementById('charLimit2');
        const charLimit = 40;


        if (userSettingsBTN) {
            userSettingsBTN.addEventListener('click', () => {
                modal.style.display = "flex";
            });
        }


        if (closeButton) {
            closeButton.addEventListener('click', () => {
                modal.style.display = "none";
            });
        }


        statusInput.addEventListener('input', () => {
            const remainingChars = charLimit - statusInput.value.length;
            charLimitDisplay.textContent = remainingChars;


            if (remainingChars <= 5) {
                charLimitDisplay.style.color = 'red';
            } else {
                charLimitDisplay.style.color = '';
            }
        });


        if (saveButton) {
            saveButton.addEventListener('click', () => {
                const status = statusInput.value.trim();
                if (status !== "") {
                    document.getElementById('status-message').textContent = `Your status: ${status}`;
                    statusInput.value = "";
                    modal.style.display = "none";
                    charLimitDisplay.textContent = charLimit;

                    const user = auth.currentUser;
                    if (user) {
                        const userStatusRef = ref(database, "users/" + user.uid + "/status");
                        set(userStatusRef, status);
                    }
                }
            });
        }


        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userPresenceRef = ref(database, "presence/" + user.uid);
                set(userPresenceRef, { name: user.displayName || "Unknown", photo: user.photoURL || "default.png" });
                onDisconnect(userPresenceRef).remove();

                const presenceRef = ref(database, "presence");


                setInterval(() => {
                    onValue(presenceRef, (snapshot) => {
                        let onlineUsers = "";
                        const userPromises = [];

                        snapshot.forEach(childSnapshot => {
                            const userInfo = childSnapshot.val();
                            const userStatusRef = ref(database, "users/" + childSnapshot.key + "/status");

                            const statusPromise = new Promise((resolve) => {
                                onValue(userStatusRef, (statusSnapshot) => {
                                    const status = statusSnapshot.val() || "";
                                    resolve({ userInfo, status });
                                });
                            });

                            userPromises.push(statusPromise);
                        });

                        Promise.all(userPromises).then(userStatusArray => {
                            userStatusArray.forEach(({ userInfo, status }) => {
                                const truncatedStatusStr = status.length > 35 ? status.slice(0, 35) + '...' : status;
                                const escapedTruncatedStatus = escapeHTML(truncatedStatusStr);
                                const escapedFullStatus = escapeHTML(status);

                                onlineUsers += `
            <div style="display:flex;align-items:center;margin-bottom:5px;cursor:pointer;" class="swag" data-name="${userInfo.name}" data-photo="${userInfo.photo}" data-status="${escapedFullStatus}">
                <img src="${userInfo.photo}" style="width:30px;height:30px;border-radius:50%;margin-right:10px;" onerror="this.src='default.png'">
                ${userInfo.name}
            </div>
            <div style="font-size:12px;display: flex; margin-top: -10px; margin-left: 58px;${!status ? 'display: none;' : ''}">
                <span class="status-truncated" title="${escapedFullStatus}">${escapedTruncatedStatus}</span>
            </div>
        `;
                            });

                            document.querySelector(".online").innerHTML = onlineUsers;
                        });
                    });
                }, 2000);

                document.getElementById('chat-container').style.display = "block";
                document.getElementById('login-container').style.display = "none";
                const profileButtonImg = document.querySelector("#profile img");
                if (profileButtonImg) {
                    profileButtonImg.src = user.photoURL || "default.png";
                }
                attachChatEventListeners();
                loadMessages();
            } else {
                document.getElementById('chat-container').style.display = "none";
                document.getElementById('login-container').style.display = "flex";
                const profileButtonImg = document.querySelector("#profile img");
                if (profileButtonImg) {
                    profileButtonImg.src = "default.png";
                }
            }
        });

        let currentOpenElement = null;

        document.body.addEventListener("click", function (event) {
            const userElement = event.target.closest(".swag");
            const userContainer = document.querySelector('.user-container');

            const user = auth.currentUser;


            if (userElement) {
                const name = userElement.getAttribute("data-name");
                if (name === user.displayName) {
                    document.querySelector(".user-options").style.display = "none";
                } else {
                    document.querySelector(".user-options").style.display = "inline-block";
                }

                if (userElement === currentOpenElement) {
                    currentOpenElement = null;
                } else {
                    const photo = userElement.getAttribute("data-photo") || "default.png";
                    const status = userElement.getAttribute("data-status") || "No status...";

                    document.getElementById("profile-name").textContent = name;
                    document.getElementById("profile-pfp").src = photo;
                    document.getElementById("profile-status").textContent = status;

                    userContainer.style.display = "flex";
                    userContainer.style.position = "absolute";

                    currentOpenElement = userElement;
                }
            } else if (!event.target.closest(".user-container")) {
                currentOpenElement = null;
            }
        });


        function login(e) {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const username = document.getElementById("login-username").value.trim();
            if (e.submitter && e.submitter.textContent.trim() === "Sign up") {
                if (!username) {
                    document.getElementById("login-error").innerText = "Username is required for sign up.";
                    return;
                }
                const profilePic = document.getElementById("login-pfp") ? document.getElementById("login-pfp").value.trim() : "default.png";
                const usernameRef = ref(database, "usernames/" + username);
                get(usernameRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        document.getElementById("login-error").innerText = "Username already taken.";
                    } else {
                        createUserWithEmailAndPassword(auth, email, password).then((userCredential) => {
                            updateProfile(userCredential.user, {
                                displayName: username,
                                photoURL: profilePic
                            }).then(() => {
                                set(ref(database, "usernames/" + username), userCredential.user.uid);
                            }).catch((error) => {
                                document.getElementById("login-error").innerText = error.message;
                            });
                        }).catch((error) => {
                            document.getElementById("login-error").innerText = error.message;
                        });
                    }
                }).catch((error) => {
                    document.getElementById("login-error").innerText = error.message;
                });
            } else {
                signInWithEmailAndPassword(auth, email, password).then(() => {
                    location.reload(); // Refresh the page after sign-in
                }).catch((error) => {
                    document.getElementById("login-error").innerText = error.message;
                });
            }
        }
        window.login = login;
        window.addEventListener('beforeunload', function () {
            const user = auth.currentUser;
            if (user) {
                remove(ref(database, 'typing/' + user.uid));
            }
        });
        document.addEventListener("DOMContentLoaded", () => {
            loadSettings();
            const loadingIndicator = document.querySelector(".loadingDiv");
            const loadingStatus = document.getElementById("loadingStatus");
            loadingStatus.innerText = "Trying to sign you in...";
            let messagesLoaded = false;

            function waitForImages() {
                const images = document.querySelectorAll("#messages img");
                const imagePromises = Array.from(images).map(img => {
                    return new Promise(resolve => {
                        if (img.complete) {
                            resolve();
                        } else {
                            img.addEventListener("load", resolve);
                            img.addEventListener("error", resolve);
                        }
                    });
                });
                return Promise.all(imagePromises);

            }

            function checkIfReady() {
                if (messagesLoaded) {
                    loadingStatus.innerText = "Loading images...";
                    waitForImages().then(() => {
                        scrollToBottom();
                        loadingIndicator.style.display = "none";
                    });
                }
            }
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadingStatus.innerText = "Loading messages...";
                } else {
                    document.getElementById('login-container').style.display = "flex";
                    loadingIndicator.style.display = "none";
                }
            });

            setTimeout(() => {
                messagesLoaded = true;
                checkIfReady();
            }, 4000);
        });

        function showPreview(src, type) {
            const previewModal = document.getElementById('previewModal');
            const previewContent = document.getElementById('previewContent');
            if (type === 'image') {
                previewContent.innerHTML = `<img src="${escapeAttribute(src)}" class="preview-content">`;
            } else if (type === 'video') {
                previewContent.innerHTML = `<video controls class="preview-content"><source src="${escapeAttribute(src)}" type="video/mp4">Your browser does not support the video tag.</video>`;
            }
            previewModal.style.display = 'flex';
        }

        document.addEventListener('click', function (event) {
            const previewModal = document.getElementById('previewModal');
            if (event.target === previewModal || event.target.classList.contains('preview-content')) {
                previewModal.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const messagesList = document.getElementById('messages');
            messagesList.addEventListener('click', function (event) {
                if (event.target.tagName === 'IMG' && event.target.closest('li')) {
                    showPreview(event.target.src, 'image');
                } else if (event.target.tagName === 'VIDEO' && event.target.closest('li')) {
                    showPreview(event.target.querySelector('source').src, 'video');
                }
            });
        });

        function deleteMessage(messageId) {
            const user = auth.currentUser;
            if (user) {
                const messageRef = ref(database, 'messages/' + messageId);
                get(messageRef).then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().name === user.displayName) {
                        remove(messageRef).then(() => {
                            const messageElement = document.getElementById(messageId);
                            if (messageElement) {
                                messageElement.remove();
                            }
                        }).catch((error) => {
                            console.error("Error deleting message:", error.message);
                        });
                    }
                }).catch((error) => {
                    console.error("Error fetching message:", error.message);
                });
            }
        }
        window.deleteMessage = deleteMessage;


        // bugs: It's not updating the friend icon when both people are friended so uhhh names it would be peak if you fix :333

        let hasNewNotifications = false;
        let isNotificationPanelOpen = false;

        function updateNotificationsIcon(hasNewNotifications) {
            const notificationButton = document.getElementById("notification-btn");
            const icon = notificationButton.querySelector("img");

            icon.src = hasNewNotifications ? "notification_active.png" : "notification_not_active.png";
        }

        function updateFriendIconForBothUsers(friendId) {
            const user = auth.currentUser;
            if (user) {
                Promise.all([
                    get(ref(database, `friends/${user.uid}/${friendId}`)),
                    get(ref(database, `friends/${friendId}/${user.uid}`))
                ]).then(([userSnapshot, friendSnapshot]) => {
                    if (userSnapshot.exists() && friendSnapshot.exists()) {
                        updateFriendButtonIconForUser(user.uid);
                        updateFriendButtonIconForUser(friendId);
                    }
                }).catch(error => {
                    console.error("Error checking friendship status: ", error);
                });
            }
        }

        function updateFriendButtonIconForUser(friendId) {
            document.querySelectorAll(`[data-friended-id="${friendId}"]`).forEach(button => {
                const icon = button.querySelector("img");
                if (icon) {
                    icon.src = "friend_added.png";
                }
            });
        }

        function loadNotifications() {
            const user = auth.currentUser;
            if (user && !isNotificationPanelOpen) {
                const notificationsRef = ref(database, `notifications/${user.uid}`);

                hasNewNotifications = false;

                onValue(notificationsRef, (snapshot) => {
                    const notifications = snapshot.val();
                    const notificationList = document.getElementById("notification-list");
                    notificationList.innerHTML = "";

                    if (notifications) {
                        for (const messageId in notifications) {
                            const message = notifications[messageId];
                            const notificationItem = document.createElement("li");
                            notificationItem.id = "notification-item";
                            notificationItem.textContent = message.text;

                            if (message.type === 'friend_request') {
                                notificationItem.style.color = '#FF0000';

                                const acceptButton = document.createElement("button");
                                acceptButton.textContent = "Accept";
                                acceptButton.addEventListener("click", function () {
                                    acceptFriendRequest(messageId, message.senderId);
                                });
                                notificationItem.appendChild(acceptButton);

                                const ignoreButton = document.createElement("button");
                                ignoreButton.textContent = "Ignore";
                                ignoreButton.addEventListener("click", function () {
                                    ignoreFriendRequest(messageId, user.uid);
                                });
                                notificationItem.appendChild(ignoreButton);
                            }

                            notificationList.appendChild(notificationItem);
                            hasNewNotifications = true;
                        }
                    } else {
                        const noNotificationsItem = document.createElement("li");
                        noNotificationsItem.textContent = "No new notifications";
                        notificationList.appendChild(noNotificationsItem);
                    }

                    updateNotificationsIcon(hasNewNotifications);
                });
            }
        }

        function acceptFriendRequest(notificationId, senderId) {
            const user = auth.currentUser;
            if (user) {
                setTimeout(() => {
                    remove(ref(database, `notifications/${user.uid}/${notificationId}`));
                    remove(ref(database, `notifications/${senderId}/${notificationId}`));
                }, 4000);


                remove(ref(database, `friendRequests/${senderId}/${user.uid}`));


                set(ref(database, `friends/${user.uid}/${senderId}`), { timestamp: Date.now() });
                set(ref(database, `friends/${senderId}/${user.uid}`), { timestamp: Date.now() });


                const notificationForFriend = {
                    text: `${user.displayName} has accepted your friend request!`,
                    timestamp: Date.now(),
                    type: 'friend_request_accepted'
                };
                const newNotificationKey = push(ref(database, `notifications/${senderId}`)).key;
                set(ref(database, `notifications/${senderId}/${newNotificationKey}`), notificationForFriend);


                setTimeout(() => {
                    const notificationRef = ref(database, `notifications/${senderId}/${newNotificationKey}`);
                    remove(notificationRef);
                }, 4000);

                const notificationRef = ref(database, `notifications/${user.uid}/${notificationId}`);
                remove(notificationRef);


                updateFriendIconForBothUsers(senderId);
                loadNotifications();
            }
        }

        function ignoreFriendRequest(notificationId, userId) {
            const user = auth.currentUser;
            if (user) {
                setTimeout(() => {
                    remove(ref(database, `notifications/${userId}/${notificationId}`));
                    remove(ref(database, `notifications/${user.uid}/${notificationId}`));
                }, 4000);
                loadNotifications();
            }
        }


        setInterval(() => {
            if (!isNotificationPanelOpen) {
                loadNotifications();
            }
        }, 5000);

        window.addEventListener("load", () => {
            const user = auth.currentUser;
            if (user) {
                document.querySelectorAll("[data-friended-id]").forEach(button => {
                    const friendId = button.getAttribute("data-friended-id");
                    updateFriendIconForBothUsers(friendId);
                });
            }
        });


        document.getElementById("notification-btn").addEventListener("click", function () {
            const notificationContainer = document.getElementById("notification");

            if (notificationContainer.style.display === "none" || notificationContainer.style.display === "") {
                notificationContainer.style.display = "block";
                isNotificationPanelOpen = true;

                hasNewNotifications = false;
                updateNotificationsIcon(hasNewNotifications);
            } else {
                notificationContainer.style.display = "none";
                isNotificationPanelOpen = false;
            }
        });

        document.getElementById("closeNOTI").addEventListener("click", function () {
            document.getElementById("notification").style.display = "none";
            isNotificationPanelOpen = false;
        });


        document.querySelectorAll("[data-friended-id]").forEach(button => {
            button.addEventListener("click", friendRequest);
        });


        document.addEventListener("click", function (event) {
            console.log("Click detected!");
            if (event.target.closest("#friend-btn")) {
                console.log("Friend button clicked!");
                friendRequest(event);
            }
        });

        function friendRequest(event) {
            const user = auth.currentUser;
            if (user) {
                const button = event.target.closest("#friend-btn");
                const friendedId = button.getAttribute("data-friended-id");

                console.log("Current User ID:", user.uid);
                console.log("Friended ID:", friendedId);

                const friendRequestRef = ref(database, `friendRequests/${friendedId}/${user.uid}`);

                get(friendRequestRef).then(snapshot => {
                    if (!snapshot.exists()) {
                        set(friendRequestRef, {
                            timestamp: Date.now(),
                            status: 'pending',
                            senderId: user.uid
                        });

                        const notificationRef = ref(database, `notifications/${friendedId}`);
                        const newNotification = {
                            text: `${user.displayName} sent you a friend request!`,
                            timestamp: Date.now(),
                            type: 'friend_request',
                            senderId: user.uid
                        };
                        const newNotificationKey = push(notificationRef).key;
                        set(ref(database, `notifications/${friendedId}/${newNotificationKey}`), newNotification);
                    }
                }).catch(error => {
                    console.error("Error checking if friend request already exists: ", error);
                });
            }
        }

        function getUserIdByUsername(username) {
            return new Promise((resolve, reject) => {
                get(ref(database, `usernames/${username}`)).then(snapshot => {
                    if (snapshot.exists()) {
                        resolve(snapshot.val());
                    } else {
                        reject("Username not found");
                    }
                }).catch(error => {
                    reject(error);
                });
            });
        }


        // you can go shit yourself names :middle_finger:

        document.body.addEventListener("click", function (event) {
            const userContainer = document.querySelector(".user-container");
            const userElement = event.target.closest(".swag");


            const user = auth.currentUser;


            userContainer.innerHTML = `<div class="user-options">
            <button id="friend-btn" data-friended-id="${user.uid}">
                <img src="assets/friend.png" alt="Friend Button" class="friend-img" />
            </button>
            <!--<button id="block-btn">
                <img src="assets/block-img.png" alt="Block this person?" class="block-img">
            </button> Block button -->
        </div>
        <img id="profile-pfp" src="assets/default.png" alt="Profile Picture" onerror="this.src='assets/default.png'" class="user-img"
            height="100px" width="100px" style="border-radius: 50%;">
        <p id="profile-name" class="username" style="font-size: 40px;"></p>

        <div class="user-desc">
            <p id="profile-status" class="desc" style="font-size: 15px;">gay f</p>
        </div>`;

            if (userElement) {
                const name = userElement.getAttribute("data-name");
                if (name === user.displayName) {
                    document.querySelector(".user-options").style.display = "none";
                } else {
                    document.querySelector(".user-options").style.display = "none";
                }

                if (userElement === currentOpenElement) {
                    userContainer.style.display = "none";
                    currentOpenElement = null;
                } else {
                    const photo = userElement.getAttribute("data-photo") || "assets/default.png";
                    const status = userElement.getAttribute("data-status") || "No status...";

                    document.getElementById("profile-name").textContent = name;
                    document.getElementById("profile-pfp").src = photo;
                    document.getElementById("profile-status").textContent = status;

                    userContainer.style.display = "flex";
                    userContainer.style.position = "absolute";

                    const onlineBar = document.querySelector(".online");
                    const onlineRect = onlineBar.getBoundingClientRect();
                    const offset = 40;

                    userContainer.style.top = `${onlineRect.top + window.scrollY + offset}px`;
                    userContainer.style.left = `${onlineRect.left - userContainer.offsetWidth - 10}px`;

                    currentOpenElement = userElement;
                }
            } else if (!event.target.closest(".user-container")) {
                userContainer.style.display = "none";
                currentOpenElement = null;
            }
        });


    </script>
</head>

<body>
    <div id="notification" style="display: none;">
        <h2>Notifications</h2>
        <span id="closeNOTI">&times;</span>
        <ul id="notification-list"></ul>

    </div>

    <div class="user-container" style="display: none;">
            <div class="user-options">
                <button id="friend-btn">
                    <img src="friend.png" alt="Friend Button" class="friend-img" />
                </button>
                <!--<button id="block-btn">
                <img src="block-img.png" alt="Block this person?" class="block-img">
            </button> Block button -->
            </div>
            <img id="profile-pfp" src="default.png" alt="Profile Picture" onerror="this.src='default.png'"
                class="user-img" height="100px" width="100px" style="border-radius: 50%;">
            <p id="profile-name" class="username" style="font-size: 40px;" data-username="{{FRIENDUSERNAME}}"></p>

            <div class="user-desc">
                <p id="profile-status" class="desc" style="font-size: 15px;">gay f</p>
            </div>
        </div>
    <div id="login-container" class="signInForm">
        <h1>Welcome back to Senera (Public Beta)</h1>
        <form id="login-form" style="display: inline-block;" onsubmit="login(event)">
            <label for="login-username">Username (not required for sign in)</label><br>
            <input type="text" id="login-username"
                placeholder="The unique account name connected to your account."><br><br>
            <label for="login-email">Email</label><br>
            <input type="email" id="login-email" placeholder="The email connected to your account." required><br><br>
            <label for="login-password">Password</label><br>
            <input type="password" id="login-password" placeholder="Your password (don't forget this!)"
                required><br><br>
            <button type="submit">Sign in</button>
            <button type="submit">Sign up</button>
            <p id="tos-notice" style="color: red;">By using Senera, I agree to the <a href="https://senera.freakybob.site/tos">TOS</a>.</p>
            <p id="login-error" style="color: red;"></p>
        </form>
    </div>
<!--    <script>
        const signupCaptcha = document.getElementById('signupCaptcha');

signupCaptcha.addEventListener('verified', (e) => {
    console.log('verified event', {token: e.token});
});
signupCaptcha.addEventListener('error', (e) => {
    console.log('error event', {error: e.error});
});
    </script>-->
    <div id="chat-container" style="display: none;">
        <div class="gradientfortop"></div>
        <ul id="messages"></ul>
        <div id="typingIndicator"></div>
        <form id="message-form" autocomplete="off">
            <p id="warning-message" style="color: red; display: none; text-align: center; font-weight: bold;"></p>
            <div id="msg">
                <div id="replyIndicator" style="display: none;"></div>
                <input type="text" id="message" placeholder="Send a message" maxlength="300">
                <h1 id="charLimit">300</h1>
                <button id="send" type="submit"><img src="send.svg" alt="Send"></button>
            </div>
        </form>

        <div class="online">loading...</div>
        <div id="menu">
            <button id="profile" class="user-settingsBTN" title="Profile"><img src="default.png"
                    style="width:40px;height:40px;border-radius:50%;" alt="Profile"
                    onerror="this.src='default.png'"></button>
            <button id="notification-btn" title="notifications"><img src="notification_not_active.png"
                    alt="notifications"></button>
            <button id="settings" title="Settings"><img src="settings.svg" alt="Settings"></button>
            <button id="help" title="Help"><img src="help.svg" alt="Help"></button>
        </div>
        <div id="modal-settings" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Settings</h2>
                <form onsubmit="return false;" autocomplete="off">
                    <input type="checkbox" id="loadYouTubeEmbedsC" checked>
                    <label for="loadYouTubeEmbedsC">Load YouTube Embeds (disable if using a low-mem system)</label>
                    <br>
                    <input type="checkbox" id="loadImageEmbedsC" checked>
                    <label for="loadImageEmbedsC">Load images (recommended)</label>
                    <br>
                    <input type="checkbox" id="unloadMessagesC" checked>
                    <label for="unloadMessagesC" title="Automatically unload messages before the latest 50.">Unload
                        messages (recommended)</label>
                    <br>
                    <input type="checkbox" id="pingSoundC" checked>
                    <label for="pingSoundC">Enable pings</label>
                    <br>
                    <button type="button" id="LOGOUTTHANKSNOMAFORTHECODEongioweyouone">Log out</button>
                    <button type="button" id="saveSettings">Save</button>
                </form>
            </div>
        </div>

        <div id="modal-feedback" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>What</h2>
                <p>You shouldn't see this.</p>
            </div>
        </div>
        <div id="modal-help" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Help</h2>
                <p>Need help getting around? Uhh..</p>
                <strong>Devs:</strong>
                <li>Freakybob Team (general owner of the project)</li>
                <li>Squirrel (Added Embeds, Emojis and more =3)</li>
                <li>Nomaakip (Helped with the frontend, features and made the desktop app)</li>
                <li>Wish (Made the linux port of Senera)</li>
                <li>mpax235 (Fixed some stuff)</li>
                <li>All the people at Stack Overflow 13 years ago</li>
                <li>ChatGPT for the backend stuff</li>
                <br>
                <div id="separator" style="height: 1px; background-color: #ccc;"></div>
                <br>
                <strong>Open Source Attributions:</strong>
                <li>Senera is licensed under <a href="https://github.com/Freakybob-Team/senera/blob/main/LICENSE">GPL-3.0</a>.</li>
                <li>Google Material Design Icons, licensed under the Apache 2.0 License.</li>
                <li>Material Design Sounds by Google, CC-BY 4.0</li>
                <li>Twemoji provided by Jason Sofonia & Justine De Caires (originally Twitter), licensed under the MIT
                    License.</li>
                <li>Twemoji by jdecked on GitHub, adapted from "Twemoji" by Twitter, CC-BY 4.0.</li>
            </div>
        </div>
        <div id="user-settings" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Profile</h2>
                <form onsubmit="return false;" autocomplete="off">
                    <label for="settings-pfp">Profile Picture URL:</label><br>
                    <input type="url" id="settings-pfp" placeholder="Enter image URL (default.png)"><br><br>
                    <p id="status-message">Change your status</p>
                    <input type="text" id="status" placeholder="Change your status" maxlength="40">
                    <span id="charLimit2">40</span>
                    <br>
                    <button type="button" style="margin-top: 4px;" id="saveStatus">Save status</button>
                    <button type="button" id="savePFP">Save profile picture</button>
                </form>
            </div>
        </div>
    </div>

    <div class="loadingDiv">
        <img src="loading.gif">
        <p><b>Senera Public Beta</b></p>
        <p1 id="loadingStatus">Trying to sign you in...</p1>
    </div>
    <div id="previewModal" class="preview-modal">
        <div id="previewContent"></div>
    </div>


</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        twemoji.parse(document.body, {
            folder: 'svg',
            ext: '.svg'

        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/@hcaptcha/vanilla-hcaptcha"></script>
</html>
